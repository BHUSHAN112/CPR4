<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CPR Sensor Bluetooth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="manifest.json" />
<style>
  body {
    font-family: Arial, sans-serif;
    background: #ffffff;
    text-align: center;
    padding: 18px;
    color: #37474f;
  }
  h2 { color: #2e7d32; margin-bottom: 8px; }
  .btn {
    padding: 10px 18px;
    margin: 6px;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #connectBtn { background: #388e3c; color: white; }
  #disconnectBtn { background: #d32f2f; color: white; display: none; }
  #startTrainingBtn { background: #388e3c; color: white; display: none; }
  #stopTrainingBtn { background: #f57c00; color: white; display: none; }
  #downloadBtn { background: #fbc02d; color: black; display: none; }
  #traineeName { padding: 8px; font-size: 14px; display: none; border-radius: 6px; border: 1px solid #ccc; }

  .status-dot {
    display: inline-block;
    width: 12px; height: 12px;
    border-radius: 50%;
    background: #d32f2f;
    margin-left: 8px;
  }

  .top-half { max-width: 780px; margin: 0 auto; }
  .bottom-half { max-width: 780px; margin: 18px auto 0; }

  .gauge-container {
    margin-top: 18px;
    width: 540px;
    height: 300px;
    margin-left: auto;
    margin-right: auto;
    position: relative;
  }
  svg { width: 100%; height: 100%; overflow: visible; }
  .needle {
    stroke-width: 6;
    transform-origin: 270px 250px;
    transition: transform 0.6s ease-in-out, stroke 0.25s ease-in-out;
    stroke-linecap: round;
  }
  .needle-shadow {
    stroke: rgba(0,0,0,0.18);
    stroke-width: 9;
    transform-origin: 270px 250px;
    stroke-linecap: round;
  }
  .center-cap { fill: #37474f; }
  .tick-label { font-size: 14px; fill: #37474f; text-anchor: middle; }
  .tick-line { stroke: #37474f; stroke-width: 2; stroke-linecap: round; }
  .tick-major { stroke-width: 3; }

  .depth-wrapper {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .depth-value {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .segments {
    width: 540px;
    height: 36px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    margin-bottom: 8px;
  }
  .segment {
    flex: 1 1 0;
    height: 100%;
    margin-left: 6px;
    margin-right: 6px;
    border-radius: 6px;
    background: rgba(0,0,0,0.06);
    transition: transform 0.3s ease;
    overflow: hidden;
  }
  .segment-inner {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 0%;
    transition: width 0.5s ease;
    border-radius: 6px;
  }
  .depth-scale {
    width: 540px;
    display: flex;
    justify-content: space-between;
    font-size: 0.95rem;
    color: #37474f;
  }
</style>
</head>
<body>
<h2>CPR Sensor <span class="status-dot" id="statusDot"></span></h2>
<div>
  <button id="connectBtn" class="btn">Connect</button>
  <button id="disconnectBtn" class="btn">Disconnect</button>
</div>
<div style="margin-top:6px;">
  <input id="traineeName" placeholder="Enter trainee name" />
  <button id="startTrainingBtn" class="btn">Start Training</button>
  <button id="stopTrainingBtn" class="btn">Stop Training</button>
  <button id="downloadBtn" class="btn">Download CSV</button>
</div>
<div class="top-half">
  <div class="gauge-container">
    <svg viewBox="0 0 540 320">
      <defs>
        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#d32f2f"/>
          <stop offset="50%" stop-color="#fbc02d"/>
          <stop offset="100%" stop-color="#388e3c"/>
        </linearGradient>
      </defs>
      <path d="M 80 250 A 190 190 0 0 1 460 250" stroke="url(#gaugeGradient)" stroke-width="26" fill="none" stroke-linecap="round"/>
      <g id="ticks"></g>
      <line id="needleShadow" x1="270" y1="250" x2="270" y2="80" class="needle-shadow"/>
      <line id="needle" x1="270" y1="250" x2="270" y2="80" class="needle" stroke="#37474f"/>
      <circle cx="270" cy="250" r="10" class="center-cap"/>
    </svg>
  </div>
</div>
<div class="bottom-half">
  <div class="depth-wrapper">
    <div id="depthValue" class="depth-value">Depth: 0.0 mm</div>
    <div class="segments" id="segmentsContainer"></div>
    <div class="depth-scale">
      <div>0</div><div>10</div><div>20</div><div>30</div><div>40</div><div>50</div><div>60 mm</div>
    </div>
  </div>
</div>
<script>
const SERVICE_UUID = '6e400001-c352-11e5-953d-0002a5d5c51b';
const CHARACTERISTIC_UUID = '6e400003-c352-11e5-953d-0002a5d5c51b';
const cx = 270, cy = 250, r = 190;
const maxRate = 120;
const ticksGroup = document.getElementById('ticks');
const needle = document.getElementById('needle');
const needleShadow = document.getElementById('needleShadow');
const segmentsContainer = document.getElementById('segmentsContainer');
const depthValueEl = document.getElementById('depthValue');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const startTrainingBtn = document.getElementById('startTrainingBtn');
const stopTrainingBtn = document.getElementById('stopTrainingBtn');
const downloadBtn = document.getElementById('downloadBtn');
const traineeNameInput = document.getElementById('traineeName');
const statusDot = document.getElementById('statusDot');
let device = null, characteristic = null, logging = false, traineeName = "", sessionData = [];

function drawTicks(){
  for(let v=0; v<=maxRate; v+=10){
    const f=v/maxRate, angle=180+f*180, rad=angle*Math.PI/180;
    const tickOuter=r, tickLen=(v%20===0)?24:12, tickInner=r-tickLen;
    const x1=cx+tickOuter*Math.cos(rad), y1=cy+tickOuter*Math.sin(rad);
    const x2=cx+tickInner*Math.cos(rad), y2=cy+tickInner*Math.sin(rad);
    const tick=document.createElementNS("http://www.w3.org/2000/svg","line");
    tick.setAttribute("x1",x1.toFixed(2));
    tick.setAttribute("y1",y1.toFixed(2));
    tick.setAttribute("x2",x2.toFixed(2));
    tick.setAttribute("y2",y2.toFixed(2));
    tick.setAttribute("class","tick-line");
    if(v%20===0) tick.classList.add('tick-major');
    ticksGroup.appendChild(tick);
    const labelRadius=r-48, lx=cx+labelRadius*Math.cos(rad), ly=cy+labelRadius*Math.sin(rad);
    const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x",lx.toFixed(2));
    txt.setAttribute("y",(ly+6).toFixed(2));
    txt.setAttribute("class","tick-label");
    txt.textContent=v;
    ticksGroup.appendChild(txt);
  }
}
function buildSegments(){
  for(let i=0;i<12;i++){
    const seg=document.createElement('div');
    seg.className='segment';
    const inner=document.createElement('div');
    inner.className='segment-inner';
    seg.appendChild(inner);
    segmentsContainer.appendChild(seg);
  }
}
function updateNeedle(rate){
  const limited=Math.max(0,Math.min(rate,maxRate));
  const angleDeg=180+(limited/maxRate)*180;
  const rotation=angleDeg-270;
  needle.style.transform=`rotate(${rotation}deg)`;
  needleShadow.style.transform=`rotate(${rotation}deg)`;
}
function mapPeaksToDepth(peaks){
  let depth=0,zone='red';
  if(peaks<=1){depth=15+Math.random()*10;zone='red';}
  else if(peaks===2){depth=30+Math.random()*10;zone='yellow';}
  else {depth=45+Math.random()*15;zone='green';}
  return {depth:parseFloat(depth.toFixed(1)),zone};
}
function updateDepthBar({depth,zone}){
  const fillSegments=Math.round((depth/60)*12);
  const segs=Array.from(segmentsContainer.children);
  const zoneColor=zone==='green'?'#388e3c':zone==='yellow'?'#fbc02d':'#d32f2f';
  segs.forEach((seg,i)=>{
    const inner=seg.firstChild;
    if(i<fillSegments){inner.style.width='100%';inner.style.background=zoneColor;}
    else {inner.style.width='0%';}
  });
  depthValueEl.textContent=`Depth: ${depth.toFixed(1)} mm`;
  depthValueEl.style.color=zoneColor;
}
function handleNotification(raw){
  const mRate=raw.match(/CPR\s*RATE:\s*([\d.]+)/i);
  const mPeaks=raw.match(/Peaks\s*in\s*last\s*5s:\s*(\d+)/i);
  if(mRate){const rate=parseFloat(mRate[1]);updateNeedle(rate);}
  if(mRate&&mPeaks){
    const rate=parseFloat(mRate[1]);
    const peaks=parseInt(mPeaks[1],10);
    const depthObj=mapPeaksToDepth(peaks);
    updateDepthBar(depthObj);
    if(logging){sessionData.push({trainee:traineeName,time:new Date().toISOString(),rate,peaks,depth:depthObj.depth});}
  }
}
connectBtn.addEventListener('click',async()=>{
  try{
    device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:'Proteus'}],optionalServices:[SERVICE_UUID]});
    const server=await device.gatt.connect();
    const service=await server.getPrimaryService(SERVICE_UUID);
    characteristic=await service.getCharacteristic(CHARACTERISTIC_UUID);
    characteristic.addEventListener('characteristicvaluechanged',event=>{
      const raw=new TextDecoder().decode(event.target.value);
      handleNotification(raw.replace(/\r/g,''));
    });
    await characteristic.startNotifications();
    statusDot.style.background='#388e3c';
    connectBtn.style.display='none';
    disconnectBtn.style.display='inline-block';
    traineeNameInput.style.display='inline-block';
    startTrainingBtn.style.display='inline-block';
  }catch(err){alert('Bluetooth Error: '+err.message);}
});
disconnectBtn.addEventListener('click',async()=>{
  if(device?.gatt?.connected) await device.gatt.disconnect();
  statusDot.style.background='#d32f2f';
  connectBtn.style.display='inline-block';
  disconnectBtn.style.display='none';
  traineeNameInput.style.display='none';
  startTrainingBtn.style.display='none';
  stopTrainingBtn.style.display='none';
  downloadBtn.style.display='none';
  logging=false;sessionData=[];
});
startTrainingBtn.addEventListener('click',()=>{
  if(!traineeNameInput.value.trim()){alert('Please enter trainee name.');return;}
  traineeName=traineeNameInput.value.trim();
  logging=true;sessionData=[];
  traineeNameInput.style.display='none';
  startTrainingBtn.style.display='none';
  stopTrainingBtn.style.display='inline-block';
});
stopTrainingBtn.addEventListener('click',()=>{
  logging=false;stopTrainingBtn.style.display='none';
  if(sessionData.length>0) downloadBtn.style.display='inline-block';
});
downloadBtn.addEventListener('click',()=>{
  let csv='Trainee Name,Time,CPR Rate,Peaks,Depth(mm)\n';
  sessionData.forEach(r=>{csv+=`${r.trainee},${r.time},${r.rate},${r.peaks},${r.depth}\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`${traineeName||'trainee'}_cpr_session.csv`;
  document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
});
drawTicks();buildSegments();
</script>
</body>
</html>
